generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/center_ai_omni/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model campaign_messages {
  id              String    @id
  campaign_id     String
  contact_id      String
  message_content String
  status          String    @default("pending")
  error_message   String?
  sent_at         DateTime?
  delivered_at    DateTime?
  read_at         DateTime?
  created_at      DateTime  @default(now())
  campaigns       campaigns @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  contacts        contacts  @relation(fields: [contact_id], references: [id], onDelete: Cascade)
}

model campaigns {
  id                 String              @id
  name               String
  instance_id        String
  template_id        String?
  status             String              @default("draft")
  total_contacts     Int                 @default(0)
  sent_count         Int                 @default(0)
  failed_count       Int                 @default(0)
  interval_min       Int                 @default(3)
  interval_max       Int                 @default(10)
  riskLevel          String              @default("medium")
  scheduled_at       DateTime?
  started_at         DateTime?
  completed_at       DateTime?
  company_id         String?
  created_by         String?
  created_at         DateTime            @default(now())
  updated_at         DateTime
  campaign_messages  campaign_messages[]
  whatsapp_instances whatsapp_instances  @relation(fields: [instance_id], references: [id], onDelete: Cascade)
  message_templates  message_templates?  @relation(fields: [template_id], references: [id])
}

model chatbots {
  id                  String                @id
  name                String
  description         String?
  system_prompt       String
  is_active           Boolean               @default(true)
  created_at          DateTime              @default(now())
  updated_at          DateTime
  training_files      chatbot_training_files[]
  whatsapp_instances  whatsapp_instances[]
}

model chatbot_training_files {
  id            String   @id
  chatbot_id    String
  file_name     String
  file_url      String
  file_size     Int
  file_type     String
  uploaded_at   DateTime @default(now())
  chatbots      chatbots @relation(fields: [chatbot_id], references: [id], onDelete: Cascade)
  
  @@index([chatbot_id])
}

model contacts {
  id                String              @id
  phone_number      String
  name              String?
  company_id        String?
  metadata          Json?
  created_at        DateTime            @default(now())
  updated_at        DateTime
  campaign_messages campaign_messages[]

  @@unique([phone_number, company_id])
}

model conversations {
  id         String     @id
  title      String
  created_at DateTime   @default(now())
  updated_at DateTime
  user_id    String?
  users      users?     @relation(fields: [user_id], references: [id])
  messages   messages[]
}

model message_templates {
  id              String      @id
  name            String
  content         String
  variables       String[]    @default([])
  company_id      String?
  created_by      String?
  created_at      DateTime    @default(now())
  updated_at      DateTime
  media_name      String?
  media_type      String?
  media_url       String?
  custom_prompt   String?
  enable_sales_flow Boolean   @default(false)
  campaigns       campaigns[]
}

model messages {
  id              String        @id
  conversation_id String
  content         String
  sender          String
  timestamp       DateTime      @default(now())
  conversations   conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
}

model proxy_servers {
  id             String    @id
  url            String    @unique
  protocol       String
  host           String
  port           Int
  username       String?
  password       String?
  country        String?
  status         String    @default("testing")
  last_checked   DateTime?
  response_time  Int?
  success_rate   Int       @default(100)
  total_uses     Int       @default(0)
  total_failures Int       @default(0)
  created_at     DateTime  @default(now())
  updated_at     DateTime
}

model settings {
  id              String   @id
  user_id         String   @unique
  ai_model        String   @default("gpt-4")
  ai_temperature  Float    @default(0.7)
  max_tokens      Int      @default(2000)
  system_prompt   String?
  theme           String   @default("dark")
  language        String   @default("pt-BR")
  notifications   Boolean  @default(true)
  chatbot_name    String   @default("CENTER AI")
  chatbot_avatar  String?
  welcome_message String   @default("Olá! Como posso ajudar você hoje?")
  created_at      DateTime @default(now())
  updated_at      DateTime
  users           users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model users {
  id                     String                   @id
  name                   String
  email                  String                   @unique
  password_hash          String
  role                   UserRole                 @default(USER)
  avatar                 String?
  is_active              Boolean                  @default(true)
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  company_id             String?
  created_by             String?
  conversations          conversations[]
  settings               settings?
  users                  users?                   @relation("usersTousers", fields: [created_by], references: [id])
  other_users            users[]                  @relation("usersTousers")
  whatsapp_conversations whatsapp_conversations[]
}

model whatsapp_conversation_messages {
  id                     String                 @id
  conversation_id        String
  message_id             String
  from_me                Boolean
  content                String
  message_type           String                 @default("text")
  timestamp              DateTime               @default(now())
  whatsapp_conversations whatsapp_conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@unique([conversation_id, message_id])
  @@index([conversation_id])
}

model whatsapp_conversations {
  id                             String                           @id
  instance_id                    String
  contact_phone                  String
  contact_name                   String?
  status                         ConversationStatus               @default(ACTIVE)
  assigned_to                    String?
  tabulation_reason              TabulationReason?
  sale_type                      SaleType?
  sale_plan_name                 String?
  notes                          String?
  created_at                     DateTime                         @default(now())
  updated_at                     DateTime
  closed_at                      DateTime?
  last_message_at                DateTime                         @default(now())
  tabulated_at                   DateTime?
  whatsapp_conversation_messages whatsapp_conversation_messages[]
  users                          users?                           @relation(fields: [assigned_to], references: [id])

  @@unique([instance_id, contact_phone])
  @@index([assigned_to])
  @@index([last_message_at])
  @@index([status])
  @@index([tabulated_at])
}

model whatsapp_instances {
  id                    String              @id
  name                  String
  phone_number          String?
  status                String              @default("disconnected")
  qr_code               String?
  session_data          String?
  chatbot_id            String?
  company_id            String?
  auto_reply            Boolean             @default(true)
  created_at            DateTime            @default(now())
  updated_at            DateTime
  last_connected_at     DateTime?
  current_message_count Int                 @default(0)
  last_dns_rotation     DateTime?
  messages_per_batch    Int                 @default(50)
  proxy_url             String?
  company_name          String?
  is_active             Boolean             @default(true)
  total_messages_sent   Int                 @default(0)
  campaigns             campaigns[]
  whatsapp_messages     whatsapp_messages[]
  chatbots              chatbots?           @relation(fields: [chatbot_id], references: [id])
  
  @@index([chatbot_id])
}

model whatsapp_messages {
  id                 String             @id
  instance_id        String
  remote_jid         String
  message_id         String
  from_me            Boolean
  content            String
  message_type       String             @default("text")
  status             String?
  timestamp          DateTime           @default(now())
  whatsapp_instances whatsapp_instances @relation(fields: [instance_id], references: [id], onDelete: Cascade)

  @@unique([instance_id, message_id])
}

model tim_sales_leads {
  id                    String    @id
  instance_id           String
  contact_phone         String
  contact_name          String?
  
  // Fluxo de vendas
  flow_stage            String    @default("initial")
  
  // Dados de viabilidade
  cep                   String?
  address_number        String?
  viability_checked     Boolean   @default(false)
  is_viable             Boolean   @default(false)
  viability_response    Json?
  
  // Endereço completo
  street                String?
  neighborhood          String?
  city                  String?
  state                 String?
  complement            String?
  reference             String?
  geolocation_lat       Float?
  geolocation_lng       Float?
  
  // Dados pessoais
  full_name             String?
  cpf                   String?
  rg                    String?
  birth_date            DateTime?
  email                 String?
  alternative_phone     String?
  
  // Plano escolhido
  selected_plan_type    String?
  selected_plan_name    String?
  plan_price            Float?
  
  // Autorização e fechamento
  authorization_given   Boolean   @default(false)
  authorization_date    DateTime?
  authorization_text    String?
  
  // Metadados
  created_at            DateTime  @default(now())
  updated_at            DateTime
  completed_at          DateTime?
  notes                 String?
  conversation_history  Json?
  
  @@index([instance_id])
  @@index([contact_phone])
  @@index([flow_stage])
  @@index([created_at])
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  REOPENED
}

enum SaleType {
  INTERNET
  HEALTH_PLAN
  COMBO
  OTHER
}

enum TabulationReason {
  SALE_MADE
  CONSIDERED_EXPENSIVE
  REFUSED_NO_REASON
  NO_INTEREST_PLAN
  INTEREST_INTERNET_ONLY
  INTEREST_PLAN_ONLY
}

enum UserRole {
  ADMIN
  USER
  GUEST
  MANAGER
  ASSISTANT
}
