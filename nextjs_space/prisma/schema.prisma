
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/center_ai_omni/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// User Authentication and Management
enum UserRole {
  ADMIN
  USER
  GUEST
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(USER)
  avatar       String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  conversations Conversation[]
  settings      Settings?
  
  @@map("users")
}

model Settings {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  
  // AI Configuration
  aiModel         String   @default("gpt-4") @map("ai_model")
  aiTemperature   Float    @default(0.7) @map("ai_temperature")
  maxTokens       Int      @default(2000) @map("max_tokens")
  systemPrompt    String?  @map("system_prompt") @db.Text
  
  // User Preferences
  theme           String   @default("dark")
  language        String   @default("pt-BR")
  notifications   Boolean  @default(true)
  
  // Chatbot Customization
  chatbotName     String   @default("CENTER AI") @map("chatbot_name")
  chatbotAvatar   String?  @map("chatbot_avatar")
  welcomeMessage  String   @default("Olá! Como posso ajudar você hoje?") @map("welcome_message")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("settings")
}

model Conversation {
  id        String   @id @default(cuid())
  title     String
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  messages  Message[]
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  content        String
  sender         String       // 'user' or 'ai'
  timestamp      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// WhatsApp Integration Models
model WhatsAppInstance {
  id              String   @id @default(cuid())
  name            String   // Nome identificador da instância
  phoneNumber     String?  @map("phone_number") // Número conectado (formato: 5531999887766)
  status          String   @default("disconnected") // disconnected, connecting, connected, error, paused
  qrCode          String?  @map("qr_code") // QR code para conexão
  sessionData     String?  @map("session_data") @db.Text // Dados da sessão Baileys (JSON)
  chatbotId       String?  @map("chatbot_id") // ID do chatbot associado
  companyId       String?  @map("company_id") // ID da empresa dona da instância
  companyName     String?  @map("company_name") // Nome da empresa vinculada
  autoReply       Boolean  @default(true) @map("auto_reply") // Responder automaticamente
  isActive        Boolean  @default(true) @map("is_active") // Se o chat está ativo
  
  // Configurações de Rate Limiting e DNS Dinâmico
  messagesPerBatch Int     @default(50) @map("messages_per_batch") // Mensagens antes de rotação (10, 20, 50, 100)
  currentMessageCount Int  @default(0) @map("current_message_count") // Contador de mensagens da sessão atual
  totalMessagesSent Int    @default(0) @map("total_messages_sent") // Total de disparos realizados
  proxyUrl         String? @map("proxy_url") // URL do proxy/DNS dinâmico
  lastDnsRotation  DateTime? @map("last_dns_rotation") // Última rotação de DNS
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastConnectedAt DateTime? @map("last_connected_at")
  
  campaigns       Campaign[]
  whatsappMessages WhatsAppMessage[]
  
  @@map("whatsapp_instances")
}

model Contact {
  id              String   @id @default(cuid())
  phoneNumber     String   @map("phone_number") // Formato brasileiro: 5531999887766
  name            String?
  companyId       String?  @map("company_id")
  metadata        Json?    // Informações adicionais (JSON)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  campaignMessages CampaignMessage[]
  
  @@unique([phoneNumber, companyId])
  @@map("contacts")
}

model MessageTemplate {
  id          String   @id @default(cuid())
  name        String
  content     String   @db.Text // Template com variáveis {{nome}}, {{empresa}}, etc
  variables   String[] @default([]) // Lista de variáveis disponíveis
  mediaType   String?  @map("media_type") // 'image', 'video', 'audio', 'document'
  mediaUrl    String?  @map("media_url") // URL da mídia armazenada
  mediaName   String?  @map("media_name") // Nome original do arquivo
  companyId   String?  @map("company_id")
  createdBy   String?  @map("created_by") // ID do usuário criador
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  campaigns   Campaign[]
  
  @@map("message_templates")
}

model Campaign {
  id                String   @id @default(cuid())
  name              String
  instanceId        String   @map("instance_id")
  templateId        String?  @map("template_id")
  status            String   @default("draft") // draft, scheduled, running, paused, completed, cancelled
  totalContacts     Int      @default(0) @map("total_contacts")
  sentCount         Int      @default(0) @map("sent_count")
  failedCount       Int      @default(0) @map("failed_count")
  
  // Configurações de envio
  intervalMin       Int      @default(3) @map("interval_min") // Intervalo mínimo em segundos
  intervalMax       Int      @default(10) @map("interval_max") // Intervalo máximo em segundos
  riskLevel         String   @default("medium") // low, medium, high
  
  // Agendamento
  scheduledAt       DateTime? @map("scheduled_at")
  startedAt         DateTime? @map("started_at")
  completedAt       DateTime? @map("completed_at")
  
  companyId         String?  @map("company_id")
  createdBy         String?  @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  instance          WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  template          MessageTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  messages          CampaignMessage[]
  
  @@map("campaigns")
}

model CampaignMessage {
  id              String   @id @default(cuid())
  campaignId      String   @map("campaign_id")
  contactId       String   @map("contact_id")
  messageContent  String   @map("message_content") @db.Text
  status          String   @default("pending") // pending, sent, failed, delivered, read
  errorMessage    String?  @map("error_message")
  sentAt          DateTime? @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")
  readAt          DateTime? @map("read_at")
  createdAt       DateTime @default(now()) @map("created_at")
  
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact         Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  @@map("campaign_messages")
}

model WhatsAppMessage {
  id              String   @id @default(cuid())
  instanceId      String   @map("instance_id")
  remoteJid       String   @map("remote_jid") // ID do contato no WhatsApp
  messageId       String   @map("message_id") // ID da mensagem no WhatsApp
  fromMe          Boolean  @map("from_me")
  content         String   @db.Text
  messageType     String   @default("text") @map("message_type") // text, image, audio, video, document
  status          String?  // sent, delivered, read
  timestamp       DateTime @default(now())
  
  instance        WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  @@unique([instanceId, messageId])
  @@map("whatsapp_messages")
}

// Proxy Server Pool para rotação de IP
model ProxyServer {
  id              String   @id @default(cuid())
  url             String   @unique // Formato: http://user:pass@host:port ou socks5://host:port
  protocol        String   // http, https, socks5
  host            String
  port            Int
  username        String?
  password        String?
  country         String?  // País do proxy para geolocalização
  
  // Status e Performance
  status          String   @default("testing") // testing, active, inactive
  lastChecked     DateTime? @map("last_checked")
  responseTime    Int?     @map("response_time") // Tempo de resposta em ms
  successRate     Int      @default(100) @map("success_rate") // Taxa de sucesso (0-100)
  
  // Contadores
  totalUses       Int      @default(0) @map("total_uses") // Total de vezes usado
  totalFailures   Int      @default(0) @map("total_failures") // Total de falhas
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("proxy_servers")
}
